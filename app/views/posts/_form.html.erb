<%= form_with(model: post, local: true, html: { class: "space-y-6 bg-white rounded-xl shadow-md p-6" }) do |form| %>
<% if post.errors.any? %>
<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
    <strong class="font-bold"><%= pluralize(post.errors.count, "error") %> prohibited this post from being saved:</strong>
    <ul class="mt-1 list-disc list-inside">
        <% post.errors.each do |error| %>
        <li><%= error.full_message %></li>
        <% end %>
    </ul>
</div>
<% end %>

<div id="ai-error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4"></div>
<div id="ai-image-error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mt-2"></div>

<!-- Title -->
<div>
    <%= form.label :title, class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= form.text_field :title, id: "post_title", class: "mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border", placeholder: "Enter a catchy title" %>
</div>

<!-- Description + AI -->
<div>
    <div class="flex justify-between items-center mb-1">
        <%= form.label :description, class: "block text-sm font-medium text-gray-700" %>
        <button type="button" id="generate-description-btn" class="flex items-center space-x-2 text-sm text-blue-600 hover:text-blue-800 font-medium">
            <span><strong>Generate with AI âœ¨</strong></span>
            <svg id="generate-spinner" class="hidden animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
        </button>
    </div>
    <%= form.text_area :description,
        id: "post_description",
        rows: 8,
        class: "ckeditor-textarea mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border transition-all duration-300",
        placeholder: "Write your story here..." %>
</div>

<!-- Image + AI -->
<div>
    <div class="flex justify-between items-center mb-1">
        <%= form.label :image, class: "block text-sm font-medium text-gray-700" %>
        <button type="button" id="generate-image-btn" class="flex items-center space-x-2 text-sm text-blue-600 hover:text-blue-800 font-medium">
            <span><strong>Generate Image with AI ðŸŽ¨</strong></span>
            <svg id="generate-image-spinner" class="hidden animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
        </button>
    </div>

    <% if post.image.attached? %>
    <div class="mb-4">
        <%= image_tag post.image, class: "w-full h-64 object-cover rounded-lg" %>
    </div>
    <% end %>

    <%= form.file_field :image, id: "post_image", class: "mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" %>

    <div id="ai-image-preview" class="mt-4"></div>
</div>

<!-- ðŸ”µ Hidden field for AI image URL -->
<%= form.hidden_field :ai_image_url, id: "post_ai_image_url" %>

<!-- Publish Time -->
<div>
    <%= form.label :published_at, "Publish Time (Optional)", class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= form.datetime_local_field :published_at, value: post&.published_at&.strftime("%Y-%m-%dT%H:%M"), class: "mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" %>
    <p class="text-sm text-gray-500 mt-1">Leave empty for immediate publish</p>
</div>

<!-- Public -->
<div class="flex items-center">
    <%= form.check_box :public, class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" %>
    <%= form.label :public, "Make this post public", class: "ml-2 block text-sm text-gray-900" %>
</div>

<div class="flex justify-end space-x-3 pt-4">
    <%= link_to "Cancel", posts_path, class: "bg-gray-100 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-200 transition duration-300" %>
    <%= form.submit class: "bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-300 cursor-pointer font-medium" %>
</div>
<% end %>